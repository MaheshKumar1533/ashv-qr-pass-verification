<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>QR Code Scanner</title>
		<script src="https://unpkg.com/html5-qrcode@2.2.1/html5-qrcode.min.js"></script>
		<style>
			#reader {
				width: 100%;
				max-width: 500px;
			}
			.result {
				font-size: 1.5em;
				margin-top: 20px;
			}
		</style>
	</head>
	<body>
		<h2>Scan QR Code</h2>
		<div id="reader"></div>
		<p class="result" id="result">Waiting for scan...</p>
		<form action="" method="post">
			{{ csrf_token }} {{ form.as_p }}
			<button type="submit">Submit Gate Pass</button>
		</form>

		<script>
			function onScanSuccess(decodedText, decodedResult) {
				document.getElementById("result").innerText =
					"Scanned: " + decodedText;

				fetch(`/check_pass/?pass_number=${decodedText}`)
					.then((response) => response.json())
					.then((data) => {
						if (data.valid) {
							{
								console.log(data);
							}
						} else {
							document.querySelector(
								'input[name="pass_number"]'
							).value = decodedText;
						}
					});
			}

			function onScanError(errorMessage) {
				console.warn(errorMessage);
			}

			let scanner = new Html5QrcodeScanner("reader", {
				fps: 10,
				rememberLastUsedCamera: true,
				qrbox: 250,
			});
			scanner.render(onScanSuccess, onScanError);
		</script>
	</body>
</html>
